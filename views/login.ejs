<!DOCTYPE html>
<html lang="fr">
  <%- include('partials/head') %>
  <body>
    <%- include('partials/header') %>

    <div class="central">
      <h1><%= title %></h1>
      <br />
      <div id="login">
        <form>
          <legend>Veuillez saisir vos identifiants</legend>
          <label for="email">Email : </label>
          <input type="text" name="email" id="email" />
          <label for="password">Mot de passe : </label>
          <input type="password" name="password" id="password" />
          <button type="submit">Connexion</button>
        </form>
      </div>

      <!-- <br>
            <div id="profile" style="display:none">
                <button id="display-payload">voir le payload</button>
                <button id="disconnectBtn">déconnexion</button>
                <div id="decoded-payload"></div>
                <div>
                    <a href="#" id="member-only">expace membre</a>
                    <div id="member-data"></div>
                </div>
            </div> -->

      <div id="profile" style="display: none">
        <button id="disconnectBtn">Déconnexion</button>
        <button id="display-payload">Voir le payload</button>
        <div id="decoded-payload"></div>
      </div>
    </div>

    <footer><%- include('partials/footer') %></footer>
    <script>
      var form = document.querySelector("form");
      form.addEventListener("submit", loginUser);

      var loginArea = document.querySelector("#login");
      var profileArea = document.querySelector("#profile");

      var displayPayloadBtn = document.querySelector("#display-payload");
      displayPayloadBtn.addEventListener('click', displayPayload);
      
      var disconnectBtn = document.querySelector("#disconnectBtn");
      disconnectBtn.addEventListener("click", logoutUser);

      var connectionLinkArea = document.querySelector("#connectionLink");
      handleFormDisplay();

      function switchToLoggedinMode() {
        loginArea.style.display = "none";
        profileArea.style.display = "block";
        connectionLinkArea.innerHTML = '<a href="/login">Déconnexion</a>';
      }

      function switchToLoggedOutMode() {
        loginArea.style.display = "block";
        profileArea.style.display = "none";
        connectionLinkArea.innerHTML = '<a href="/login">Connexion</a>';
      }

      function handleFormDisplay() {
        if (localStorage.getItem("token")) {
          switchToLoggedinMode();
        } else {
          switchToLoggedOutMode();
        }
      }

      function loginUser(event) {
        loginUserWithXHR(event);
      }

      function loginUserWithXHR(event) {
        event.preventDefault();
        console.log("loginUserWithXHR");

        // https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/login", true);

        //Send the proper header information along with the request
        xhr.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded"
        );

        xhr.onreadystatechange = function () {
          //Call a function when the state changes.
          if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
            // add token to localStorage
            var token = xhr.response;
            localStorage.setItem("token", token);
            switchToLoggedinMode();

            form.reset();
          }
        };
        var email = document.getElementById("email").value;
        var password = document.getElementById("password").value;
        var payLoad = "email=" + email + "&" + "password=" + password;
        xhr.send(payLoad);
      }

      function parseJwt(){
        var tokenFromStorage = localStorage.getItem('token');
        if(tokenFromStorage){
          var base64Payload = tokenFromStorage.split('.')[1];
          return JSON.parse(window.atob(base64Payload));
        } else {
          return 'no token to parse';
        }
      }

      function displayPayload(){
        var payload = parseJwt();
        var decodedPayloadDiv = document.querySelector("#decoded-payload");
        decodedPayloadDiv.innerHTML = '<pre>' + JSON.stringify(payload) + '</pre>' ;
      }

      function logoutUser() {
        switchToLoggedOutMode();
        localStorage.removeItem("token");
      }
    </script>
  </body>
</html>
